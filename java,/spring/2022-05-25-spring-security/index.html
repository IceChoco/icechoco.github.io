<!DOCTYPE html>
<html lang="ko"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.1.4 <https://hydejack.com/>
-->







<head>
  






  
    
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Spring] Spring Security란? | IceChoco</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="[Spring] Spring Security란?" />
<meta name="author" content="Ara cho(IceChoco)" />
<meta property="og:locale" content="ko_KR, en_US" />
<meta name="description" content="이 글을 쓰는 이유" />
<meta property="og:description" content="이 글을 쓰는 이유" />
<link rel="canonical" href="https://icechoco.github.io/java,/spring/2022-05-25-spring-security/" />
<meta property="og:url" content="https://icechoco.github.io/java,/spring/2022-05-25-spring-security/" />
<meta property="og:site_name" content="IceChoco" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-25T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[Spring] Spring Security란?" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ara cho(IceChoco)"},"dateModified":"2022-06-10T14:04:26+09:00","datePublished":"2022-05-25T00:00:00+09:00","description":"이 글을 쓰는 이유","headline":"[Spring] Spring Security란?","mainEntityOfPage":{"@type":"WebPage","@id":"https://icechoco.github.io/java,/spring/2022-05-25-spring-security/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://icechoco.github.io/assets/img/developing-frog.png"},"name":"Ara cho(IceChoco)"},"url":"https://icechoco.github.io/java,/spring/2022-05-25-spring-security/"}</script>
<!-- End Jekyll SEO tag -->


  

  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="IceChoco">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta name="application-name" content="IceChoco">


  <meta name="theme-color" content="rgb(8,46,57)">


<meta name="generator" content="Hydejack v9.1.4" />


<link rel="alternate" href="https://icechoco.github.io/java,/spring/2022-05-25-spring-security/" hreflang="ko-kr, en-us">

<link type="application/atom+xml" rel="alternate" href="https://icechoco.github.io/feed.xml" title="IceChoco" />


<link rel="shortcut icon"    href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

<link rel="manifest" href="/assets/site.webmanifest">

<link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com">



<link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG">






<script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script");n.src=e,t&&a(n,"load",t,{once:!0});t=c.scripts[0];return t.parentNode.insertBefore(n,t),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
!function(w) {
  w._baseURL = '/';
  w._publicPath = '/assets/js/';
  w._noPushState = false;
  w._noDrawer = false;
  w._noNavbar = false;
  w._noToc = false;
  w._noSearch = false;
  w._search = {
    DATA_URL: '/assets/sitedata.json?no-cache',
    STORAGE_KEY: 'mini-search/',
    INDEX_KEY: 'index--2022-06-10T16:10:52+09:00',
  };
  w._clapButton = false;
}(window);</script>


<script async src="/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script>


<!--[if gt IE 8]><!---->

  




<link rel="stylesheet" href="/assets/css/hydejack-9.1.4.css" id="_stylePreload">
<link rel="stylesheet" href="/assets/icomoon/style.css" id="_iconsPreload">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload">



  <style id="_pageStyle">

html{--accent-color: rgb(79,177,186);--accent-color-faded: rgba(79,177,186,0.5);--accent-color-highlight: rgba(79,177,186,0.1);--accent-color-darkened: #409ba3;--theme-color: rgb(8,46,57)}

</style>


<!--<![endif]-->


<!--
Code used for embedding Gumroad on the Hydejack Site. 
Left here for reference, feel free to delete.
-->
<link rel="dns-prefetch" href="https://assets.gumroad.com">
<script>window.GET_CLAPS_API = 'https://worker.getclaps.dev'</script>
<script type="module">
  const ppiData = window._ppiData = fetch('https://hydejack-ppi.qwtel.workers.dev', { mode: 'cors'}).then(res => res.json()).catch(() => ({}));
  const promisify = f => x => new Promise(r => f(x).addEventListener('load', r));
  const loadJS = promisify(window.loadJS);
  {
    let p;
    document.querySelector('hy-push-state').addEventListener('load', () => {
      const io = new IntersectionObserver(async (entries) => {
        if (entries.some(x => x.isIntersecting)) {
          p = p || loadJS('https://gumroad.com/js/gumroad-embed.js');
          const [{ code }] = await Promise.all([ppiData, p]);
          document.querySelectorAll('.gumroad-product-embed').forEach(el => { 
            if (!el.dataset.gumroadParams) {
              el.dataset.gumroadParams = 'offer_code=' + (code || 'qr0tw8m');
            }
          });
          if (!window.GumroadEmbed) {
            await new Promise(function check1(res) {
              if ('createGumroadEmbed' in window) res(window.createGumroadEmbed());
              else setTimeout(() => check1(res), 200);
            });
          }
          await new Promise(function check2(res) {
            if ('GumroadEmbed' in window) res(GumroadEmbed.reload());
            else setTimeout(() => check2(res), 200);
          });
        }
      }, { rootMargin: '1440px' });
      document.querySelectorAll('.gumroad-product-embed').forEach(el => io.observe(el));
    });
  }
  {
    let p;
    document.querySelector('hy-push-state').addEventListener('load', () => {
      const io = new IntersectionObserver(async (entries) => {
        if (entries.some(x => x.isIntersecting)) {
          p = p || loadJS('https://gumroad.com/js/gumroad.js');
          const [{ code }] = await Promise.all([ppiData, p]);
          if (code) {
            document.querySelectorAll('.gumroad-button').forEach(el => { 
              if (!el.href.endsWith(code)) {
                el.href = el.href + '/' + (code || 'qr0tw8m');
              }
            });
          }
          if (!window.GumroadOverlay) {
            await new Promise(function check(res) {
              if ('createGumroadOverlay' in window) res(window.createGumroadOverlay());
              else setTimeout(() => check(res), 200);
            });
          }
        }
      }, { rootMargin: '300px' });
      document.querySelectorAll('.gumroad-button').forEach(el => io.observe(el));
    });
  }
</script>


</head>

<body>
  


<hy-push-state
  id="_pushState"
  replace-selector="#_main"
  link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)"
  script-selector="script"
  duration="500"
  hashchange
>
  
  
  

<!-- CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" />

<!--상단메뉴바-->
<div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <span class="sr-only">Jump to:</span>
    <div class="nav-btn-bar">
      <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>

      <!--상단메뉴 카테고리들 -->
    <div class="top-menu">
      <a href="/search" class="nav-btn top-menu"> 
        <i class="fas fa-fw fa-search"></i>
        <span>Search</span>
      </a>
    </div>
  </div>
  </div>
</div>
<hr class="sr-only" hidden />

  <main
  id="_main"
  class="content layout-post"
  role="main"
>
  <nav id="breadcrumbs" class="screen-only"><ul>
  
  
    <li><a href="/">home</a></li>
    
      <li>
      
        <span>/</span>
        
        
        <a href="/java,/">java,</a>
      
      </li>
    
      <li>
      
        <span>/</span>
        
        
        <a href="/java,/spring/">spring</a>
      
      </li>
    
      <li>
      
        <span>/</span>
        <span>2022-05-25-spring-security</span>
      
      </li>
    
  
</ul></nav>
  










<article id="post-java,-spring-spring-security" class="page post mb6" role="article">
  <header>
    <h1 class="post-title flip-project-title">
      
        [Spring] Spring Security란?
      
    </h1>

    <div class="post-date">
      
      <span class="ellipsis mr1">
        <time datetime="2022-05-25T00:00:00+09:00">25 May 2022</time> in <span>Java,</span> / <a href="/spring/" class="flip-title">Spring</a> on <span>Java</span>
      </span>
      
        
          
          
          
            
            
            <span class="ellipsis" data-tippy-content="Last modified at: 2022-06-10">
              <span class="sr-only">Last modified at:</span>
              <span class="icon-history"></span>
              <time datetime="2022-06-10T14:04:26+09:00">2022-06-10</time>
            </span>
          
        
      
    </div>

    
    

    



  <div class="hr pb0"></div>


  </header>

  
    <p><strong>이 글을 쓰는 이유</strong></p>

<blockquote>
  <p>Spring Security는 복잡하고 방대한 내용을 알아야 한다. OAuth2를 활용한 로그인을 구현하다 보니 Spring Security에 대한 기본기를 다지고 가야겠다 생각되어 이 글을 쓰게 되었다.</p>

  <p>참고로, 구글링 중 너무 글로 잘 정리해주신 <a href="https://dingue.tistory.com/5">딩규님의 글</a>을 찾아서 이 글을 기반으로 추가로 공부한 내용을 더해 작성하였다. 좋은 글을 정리해주신 딩규님에게 감사 말씀을 드린다.</p>
</blockquote>

<hr />

<p>우선 Spring Secuiry가 무엇인가?</p>
<ul>
  <li><strong>강력하면서 높은 수준의 커스터마이징 가능한 인증을 제공하고, 필터를 통한 접근 제어를 허용하는 프레임 워크</strong></li>
  <li>Spring 기반 애플리케이션의 보안에서는 표준</li>
</ul>

<p>현재 가장 최신 버전은 5.7.1이나 이 글을 5.1.4 버전을 기반으로 작성해보았다.</p>

<h2 id="filter">Filter</h2>
<p><img src="/assets\img/spring/spring_security_filter.png" alt="" /></p>
<ul>
  <li>spring security에서는 애플리케이션에 대한 모든 요청을 필터로 감싼뒤 처리</li>
  <li>Filter들은 chain 형식이며, 각각의 순서를 갖고 있음</li>
  <li>필터 체인의 제일 마지막에 위치한 FilterSecurityInterceptor는 앞에 지나온 모든 필터들의 정보를 토대로 최종 결정</li>
  <li>자동 설정 시 10개의 필터가 적용됨</li>
</ul>

<h2 id="authentication인증-authorization권한">Authentication(인증), Authorization(권한)</h2>
<ul>
  <li>Authentication: 애플리케이션에서 사용자가 이 애플리케이션을 사용할 자격이 있는지 확인하는 과정
    <ul>
      <li>인증을 성공적으로 마치면 사용자에게 설정된 권한을 할당</li>
      <li>ex) 로그인</li>
    </ul>
  </li>
  <li>Authorization: 접근하는 사용자가 해당 로직 및 url에 접근할 권한을 가지고 있는지 확인하는 과정(접근제어 및 권한 관리)
    <ul>
      <li>웹 요청, url, 도메인 인스턴스에 대한 접근을 관리</li>
      <li>만약 접근한 사용자가 권한이 없거나 낮으면(ex 관리자 요청인데 일반 유저가 요청한 경우) 요청을 거부함</li>
    </ul>
  </li>
</ul>

<p>즉, Spring Security는 <strong>Filter로 이루어진 시스템</strong>이고, Filter를 이용한 Authentication, Authorization으로 유저 관리 및 접근 제어를 수행하는 보안 프레임워크이다.</p>

<h2 id="authentication인증">Authentication(인증)</h2>
<h3 id="1-인증-관련-핵심-용어">1. 인증 관련 핵심 용어</h3>
<ul>
  <li>Principal: 서비스에 접근하는 유저를 가리킴(일반적으로 username, userId로 생각해도 무방함)</li>
  <li>Authentication 객체
    <ul>
      <li>Spring Security에서 한 유저의 인증 정보를 가지고 있는 객체</li>
      <li>사용자가 인증 과정을 성공적으로 마치면, Spring security는 사용자의 정보 및 인증 성공여부를 가지고 Authentication 객체를 생성한 후 보관함</li>
    </ul>
  </li>
  <li>SecurityContextHolder: Authentication 객체를 보관하는 곳. 애플리케이션 어디에서든지 접근할 수 있음
    <ul>
      <li>ex) Obeject principal = SecurityContextHolder.getContext().getAuthentication().getPrinciPal();</li>
    </ul>
  </li>
  <li>UserDetails: 일반 서비스의 사용자 객체를 Spring security에서 사용하는 사용자 객체와 호환해주는 어댑터</li>
  <li>UserDetailsService: spring security에서 로그인할 때 전달된 정보를 기반으로 DB에서 유저를 가져오는 책임을 가지는 인터페이스</li>
  <li>GrantedAuthority: 사용자에게 주어진 애플리케이션 사용 권한 객체</li>
  <li>PasswordEncoder
    <ul>
      <li>DB에 사용자의 정보 저장 시 비밀번호를 암호화</li>
      <li>인증 시 입력된 비밀번호와 저장된 비밀번호를 matching 해주는 객체</li>
    </ul>
  </li>
</ul>

<h3 id="2-인증-과정">2. 인증 과정</h3>
<p>아이디 비밀번호를 입력하는 폼 기반 로그인이라고 가정했을 떄 아래와 같은 과정을 거친다.
1) 유저가 입력한 아이디, 비밀번호를 Spring Security가 사용하는 유저의 객체로 변환시킴(UserDetails 이용)
2) 유저가 입력한 정보(예: id)를 기반으로 DB에서 사용자 정보를 가져옴(UserDtailsService 인터페이스가 하는 역할)
3) 유저가 입력한 정보와 DB에서 가져온 사용자 정보를 기반으로 인증 진행 (아래에서 설명할 AuthenticationManager 인터페이스의 authenticate() 메소드)
4) 만약에 인증에 성공했다면 유저에게 설정된 권한을 부여</p>

<h3 id="3-인증-관련-세부-내용">3. 인증 관련 세부 내용</h3>
<h4 id="authenticationmanager">AuthenticationManager</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationManager</span> <span class="o">{</span>
    <span class="nc">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">authenticate</code> 메소드를 하나 가지고 있는 인터페이스</li>
  <li>이 메소드는 Spring security에서 인증을 담당</li>
</ul>

<h4 id="providermanager">ProviderManager</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderManager</span> <span class="kd">implements</span> <span class="nc">AuthenticationManager</span><span class="o">,</span> <span class="nc">MessageSourceAware</span><span class="o">,</span> <span class="nc">InitializingBean</span> <span class="o">{</span>
    <span class="c1">//....</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Spring Security에서 AuthenticationManager의 기본 구현체</li>
  <li>이 클래스는 자신이 가지고 있는 여러 AuthenticationProvider 들에게 인증 처리를 위임함</li>
</ul>

<h4 id="authenticationprovider">AuthenticationProvider</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderManager</span> <span class="kd">implements</span> <span class="nc">AuthenticationManager</span><span class="o">,</span> <span class="nc">MessageSourceAware</span><span class="o">,</span> <span class="nc">InitializingBean</span> <span class="o">{</span>
  <span class="c1">//...</span>
    <span class="kd">public</span> <span class="nf">ProviderManager</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">AuthenticationProvider</span><span class="o">&gt;</span> <span class="n">providers</span><span class="o">,</span> <span class="nc">AuthenticationManager</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">eventPublisher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProviderManager</span><span class="o">.</span><span class="na">NullEventPublisher</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">providers</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">messages</span> <span class="o">=</span> <span class="nc">SpringSecurityMessageSource</span><span class="o">.</span><span class="na">getAccessor</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">eraseCredentialsAfterAuthentication</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">providers</span><span class="o">,</span> <span class="s">"providers list cannot be null"</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">providers</span> <span class="o">=</span> <span class="n">providers</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">checkState</span><span class="o">();</span>
    <span class="o">}</span>
<span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>실질적으로 인증을 처리하는 클래스 (authentication 메소드를 구현한 클래스)</li>
  <li>UserDetails와 UserDetailsService 그리고 PasswordEncoder를 이용해서 인증을 처리</li>
  <li>ProviderManager는 여러개의 AuthenticationProvider를 가질 수 있음</li>
  <li>여러개의 AuthenticationProvider를 가지고 있는 경우 각 순서대로 인증을 진행하거나, skip함</li>
  <li>만약 모든 AuthenticationProvider가 null을 반환(인증을 skip 하는 것)</li>
  <li>Spring Security에서 구현한 여러 AuthenticationProvider 구현체들이 있음
    <ul>
      <li>DaoAuthenticationProvider, LdapAuthenticationProvider: from 기반 로그인이나, HTTP Bagic authentication 인증을 구현한 구현체</li>
    </ul>
  </li>
</ul>

<h4 id="daoauthenticationprovider">DaoAuthenticationProvider</h4>
<ul>
  <li>유저가 입력한 username, password를 DB에서 가져온 유저정보와 비교하여 인증을 처리하는 구현체</li>
  <li>password를 비교하기 위해서 PasswordEncoder를 설정해주어야 함</li>
  <li>DB에서 유저 정보를 가져오기 위해서 UserDetailsService를 설정해 주어야 함</li>
</ul>

<h4 id="userdetailsservice">UserDetailsService</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>
	<span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>사용자가 입력한 username을 기반으로 저장된 유저정보를 가져와서 UserDetails 객체로 변환하여 돌려주는 메소드</li>
  <li><code class="language-plaintext highlighter-rouge">loadUserByUsername</code> 메소드를 하나 가지고 있는 인터페이스</li>
  <li>Spring Security에서 관련 구현체로 In-Memory Authentication, JdbcDaoImpl이 있음</li>
</ul>

<h5 id="in-memory-authentication">In-Memory Authentication</h5>
<p>Example. <user-service> {noop} XML Configuration</user-service></p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;user-service&gt;</span>
	<span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">"user"</span>
		<span class="na">password=</span><span class="s">"{noop}password"</span>
		<span class="na">authorities=</span><span class="s">"ROLE_USER"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">"admin"</span>
		<span class="na">password=</span><span class="s">"{noop}password"</span>
		<span class="na">authorities=</span><span class="s">"ROLE_USER,ROLE_ADMIN"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/user-service&gt;</span>
</code></pre></div></div>
<ul>
  <li>애플리케이션 메모리 안에 유저 정보를 저장해두고, 인증 요청이 왔을 때 이 정보들 중에서 입력된 정보와 일치하는 유저를 반환해주는 구현체</li>
  <li>프로토타입용으로만 사용하는 것이 좋음(절대 실무에서는 사용하면 안됨)</li>
</ul>

<h5 id="jdbcdaoimpl">JdbcDaoImpl</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcDaoImpl</span> <span class="kd">extends</span> <span class="nc">JdbcDaoSupport</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span><span class="o">,</span> <span class="nc">MessageSourceAware</span> <span class="o">{</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>ORM을 사용하고 있지 않다면, 이 구현체를 사용해서 DB에서 쉽게 입력된 사용자 정보를 가져올 수 있음</li>
  <li>하지만 ORM을 사용하고 있다면 굳이 이런 구현체를 사용하는 것보다, 직접 UserDetailsService 인터페이스를 구현하여 사용하느 ㄴ것이 좋음</li>
</ul>

<h4 id="userdetails">UserDetails</h4>
<ul>
  <li>Spring Security에서는 사용자 객체가 필요하지만, 모든 서비스마다 사용자 정의가 다르기 때문에 서비스와 Spring security의 사용자 객체를 호환해주는 어댑터가 필요</li>
  <li>그 어댑터의 역할을 UserDetails가 수행</li>
  <li>Spring security를 사용하는 애플리케이션에서는 이 인터페이스를 구현해야함</li>
</ul>

<h4 id="passwordencoder">PasswordEncoder</h4>
<p>패스워드 암호화의 발전 과정</p>
<ol>
  <li>초기에 password는 암호화 되지 않음
    <ul>
      <li>DB 인증을 통해서 데이터를 접근하는데 다시 password를 암호화 할 필요성을 느끼지 못함</li>
    </ul>
  </li>
  <li>SQL Injection 같은 공격을 통해 password가 털림. password 암호화의 필요성을 느낌</li>
  <li>개발자들은 SHA-256과 같은 한방향 hash 암호화를 이용하여 password 암호화를 시작</li>
  <li>공격자들은 rainbowTable이라는 것을 생성하여 한방향 hash 암호화를 무력화시킴</li>
  <li>이에 개발자들은 랜덤 바이트를 비밀번호에 섞어서 ranbowTable을 무력화 시킴</li>
  <li>현대 HW가 좋아지고, 해쉬함수가 빠르다는 것을 공격자들이 이용(1초에 10억건씩 비밀번호를 체크)</li>
  <li>이에 개발자들은 해시 암호화 알고리즘이 내부 리소스들을 엄청나게 사용하도록 변경(암호화가 1초 이상 걸리도록 설정)
    <ul>
      <li>이게 바로 로그인이 오래걸리는 이유</li>
    </ul>
  </li>
</ol>

<p>Spring Security에서는 work factor 조정을 통해 암호화 알고리즘의 속도를 설정할 수 있다.<br />
이런 work factor를 사용하는 암호화 알고리즘은 bcrypt, PBKDF2, scrypt, 그리고 Argon2가 있다.</p>

<h4 id="delegatingpasswordencoder">DelegatingPasswordEncoder</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">String</span> <span class="n">idForEncode</span> <span class="o">=</span> <span class="s">"bcrypt"</span><span class="o">;</span>
 <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">PasswordEncoder</span><span class="o">&gt;</span> <span class="n">encoders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
 <span class="n">encoders</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">idForEncode</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">());</span>
 <span class="n">encoders</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"noop"</span><span class="o">,</span> <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
 <span class="n">encoders</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"pbkdf2"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Pbkdf2PasswordEncoder</span><span class="o">());</span>
 <span class="n">encoders</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"scrypt"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SCryptPasswordEncoder</span><span class="o">());</span>
 <span class="n">encoders</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"sha256"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StandardPasswordEncoder</span><span class="o">());</span>

 <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelegatingPasswordEncoder</span><span class="o">(</span><span class="n">idForEncode</span><span class="o">,</span> <span class="n">encoders</span><span class="o">);</span>
</code></pre></div></div>
<p>Spring Security 5.0 이전에는 암호화를 하지 않고 default PasswordEncoder가 평문 패스워드였다.<br />
Spring Security에서는 하위 호환성을 위하여 그동안 이를 업그레이드하지 않다가 <code class="language-plaintext highlighter-rouge">DelegatingPasswordEncoder</code>라는 구현체를 개발하였다.</p>
<ul>
  <li>이전의 포맷이나, 현재 포맷을 같이 사용할 수 있다.</li>
  <li>미래에 쉽게 passwordEncoding 방식을 업그레이드 할 수 있다.</li>
</ul>

<h4 id="spring-security-저장-포맷">Spring security 저장 포맷</h4>
<p>일반적으로 저장 포맷은 아래와 같다</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{id}encodePassword
</code></pre></div></div>
<p>여기서 id는 어떤 passwordEncoder가 사용되었는지 볼 수 있는 식별자이고, encodedPassword는 선택된 PasswordEncoder가 원래 passwrod를 인코딩한 것이다.<br />
id는 password 시작에 있어야 하며 {로 시작해서 }로 끝난다. id를 찾을 수 없으면 id는 null이 된다.<br />
아래는 <code class="language-plaintext highlighter-rouge">password</code>라는 String을 passwordEncoder로 인코딩한 예이다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG
 {noop}password
 {pbkdf2}5d923b44a6d129f3ddf3e3c8d29412723dcbde72445e8ef6bf3b508fbf17fa4ed4d6b99ca763d8dc
 {scrypt}$e0801$8bWJaSu2IKSn9Z9kM+TPXfOc/9bdYSrN1oD9qfVThWEwdRTnO7re7Ei+fUZRJ68k9lTyuTeUp4of4g24hHnazw==$OAOec05+bXxvuu/1qZ6NUR+xQYvYv7BeL1QxwRpY5Pc=
 {sha256}97cde38028ad898ebc02e690819fa220e88c62e0699403e94fff291cfffaf8410849f27605abcbc0
</code></pre></div></div>

<p>이런 식으로 변했기 때문에 기존에 password에 id가 달려있지 않았다면 아래와 같이 업그레이드 시켜주어야 한다.
아래는 bycrypt 암호화 알고리즘을 사용한 예시이다</p>
<ul>
  <li>기존
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG
</code></pre></div>    </div>
  </li>
  <li>변경
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="4-인증-아키텍처">4. 인증 아키텍처</h3>
<p><img src="/assets\img/spring/spring_security_autehntication.png" alt="" /></p>

<h2 id="spring-security-자바-설정">Spring Security 자바 설정</h2>
<h3 id="1-springsecurityfilterchain-생성">1. SpringSecurityFilterChain 생성</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span> <span class="c1">//Spring Security 설정 활성화</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">UserDetailsService</span> <span class="n">jwtUserDetailsService</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">JwtRequestFilter</span> <span class="n">jwtRequestFilter</span><span class="o">;</span>

  <span class="c1">//...</span>
<span class="o">}</span>    
</code></pre></div></div>

<p>위 소스를 보면 클래스 위에 <code class="language-plaintext highlighter-rouge">@EnableWebSecurity</code>라는 어노테이션이 달려있는 것을 볼 수 있다. 이 어노테이션을 사용하면 SpringSecurityFilterChain이 자동으로 생성 된다.</p>

<h4 id="1-1-springsecurityfilterchain의-효과">1-1. SpringSecurityFilterChain의 효과</h4>
<ul>
  <li>애플리케이션의 모든 URL에 인증을 적용할 수 있다.</li>
  <li>기본 로그인 폼을 제공한다.</li>
  <li>폼 기반 인증을 통해 username과 password 인증을 할 수 있게 해준다.</li>
  <li>유저에게 로그아웃 기능을 제공한다.</li>
  <li>CSRF 공격을 방어해준다.</li>
  <li>세션 고정 공격을 방어해준다.</li>
  <li>통합 Security Header를 제공한다.
    <ul>
      <li>보안 요청을 위한 HTTP Strict Transport Security 제공</li>
      <li>통합 X-Context-Type-Options 제공</li>
      <li>통합 X-XSS-Protection 제공</li>
      <li>Clickjacking 방어를 도와주는 통합 X-Frame-Options 제공</li>
    </ul>
  </li>
</ul>

<h3 id="2-spring-mvc에서-abstractsecuritywebapplicationinitializer를-통한-spring-security-등록">2. Spring MVC에서 AbstractSecurityWebApplicationInitializer를 통한 Spring Security 등록</h3>
<blockquote>
  <p>jar의 경우 스프링부트에서 자동 구성을 해주기 때문에 위 설정이 따로 필요 없다. 그 이유가 궁금하다면 아래 2-4를 참조하길 바란다.<br />
war로 생성하려는 경우에는 아래와 같이 직접 구현을 해주어야 한다.</p>
</blockquote>

<h4 id="2-1-abstractsecuritywebapplicationinitializer-without-spring">2-1. AbstractSecurityWebApplicationInitializer without Spring</h4>
<p>스프링이나 스프링 MVC를 사용하고 있지 않다면, <code class="language-plaintext highlighter-rouge">WebSecurityConfig</code>를 사용할 수 있도록 이 클래스를 상위로 넘겨야 한다. 예시는 아래에 있다:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.security.web.context.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityWebApplicationInitializer</span>
    <span class="kd">extends</span> <span class="nc">AbstractSecurityWebApplicationInitializer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">SecurityWebApplicationInitializer</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">WebSecurityConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">AbstractSecurityWebApplicationInitializer</code>는 다음과 같은 일을 한다.</p>
<ul>
  <li>어플리케이션의 모든 URL에 자동으로 springSecurityFilterChain 필터를 등록한다.</li>
  <li><code class="language-plaintext highlighter-rouge">WebSecurityConfig</code>를 로드하는 ContexLoaderListner를 추가한다.</li>
</ul>

<h4 id="2-2-abstractsecuritywebapplicationinitializer-with-spring-mvc">2-2. AbstractSecurityWebApplicationInitializer with Spring MVC</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.security.web.context.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityWebApplicationInitializer</span>
        <span class="kd">extends</span> <span class="nc">AbstractSecurityWebApplicationInitializer</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>

<p>이 이후에 WebSecurityConfig가 ApplicationInitializer로 로드되도록 설정해야 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MvcWebApplicationInitializer</span> <span class="kd">extends</span>
        <span class="nc">AbstractAnnotationConfigDispatcherServletInitializer</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">getRootConfigClasses</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">WebSecurityConfig</span><span class="o">.</span><span class="na">class</span> <span class="o">};</span>
    <span class="o">}</span>

    <span class="c1">// ... other overrides ...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>이렇게 하면 기존 ApplicationInitializer에 <code class="language-plaintext highlighter-rouge">WebSecurityConfig</code>를 로드한다.
예를 들어 스프링 MVC를 사용하고 있다면 <code class="language-plaintext highlighter-rouge">getRootConfigClasses()</code>안에 추가된다.</p>

<hr />

<p>그런데 내가 개발중인 프로젝트는 AbstractSecurityWebApplicationInitializer를 직접 구현한 적이 없는데 스프링 세큐리티를 적용하여 사용중이다.<br />
엥 그럼 필수가 아니란 말인가? AbstractSecurityWebApplicationInitializer를 구현하지 않았을 때는 어떻게 동작할까?<br />
그 궁금증을 해결하기 위해 아래 2가지의 스택오버플로우 글을 읽어 보았다.</p>

<h4 id="2-3-abstractsecuritywebapplicationinitializer-vs-abstractannotationconfigdispatcherservletinitializer">2-3 AbstractSecurityWebApplicationInitializer vs. AbstractAnnotationConfigDispatcherServletInitializer</h4>
<details>
<summary>[질문 상세 내용]</summary>
<div>

    <p>3.2.8 버전의 순수 자바 어플리케이션에 세큐리티를 적용하려한다. 나는 <a href="http://docs.spring.io/spring-security/site/docs/3.2.2.RELEASE/reference/htmlsingle/#jc">스프링 세큐리티 docs</a>를 참조하고 있다.</p>

    <p>3.1 섹션을 완료했다. 그리고 문서에서는 모든 url에 authentication(인증)이 필요하지만, 세큐리티 적용안하면 모든 URL을 로드할 수 있다.<br />
문서에서는 서블릿 필터 등을 생성한다고 한다.</p>

    <p>WebSecurityConfigurerAdapter 하위 클래스만으로는 충분하지 않다. 그래서 <strong>WAR 사용 시</strong> springSecurityFilterChain을 등록에 관한 3.1.1 섹션을 보았다.<br />
이 섹션에서는 Servlet 3+ 환경에서 어떻게 사용해야하는지 설명한다. 난 <code class="language-plaintext highlighter-rouge">AbstractSecurityWebApplication</code>를 구현한 하위 클래스가 필요하다.<br />
하지만 난 이미 <code class="language-plaintext highlighter-rouge">AbstractAnnotationConfigDispatcherServletInitializer</code>에 대한 하위 클래스를 구현했다.<br />
나는 각각 하나씩 하위클래스를 갖고 있어야 할까? AbstractSecurityWebApplicationInitializer JavaDoc에 순서 지정에 대한 몇가지 논의가 있다.<br />
여기서는 내가 한 개 이상의 initializer 클래스를 갖고 있어야 함을 의미한다.</p>
  </div>
</details>

<p><strong>[정리]</strong></p>

<p>AbstractAnnotationConfigDispatcherServletInitializer에 대한 하위클래스를 이미 구현해놓은 상태인데 스프링 세큐리티 적용하려고 보니까 AbstractSecurityWebApplicationInitializer 얘도 하위클래스 확장하라고 하는데 나는 각각 둘다 확장해야되냐?는 질문이며,
답변은 맞다 AbstractSecurityWebApplicationInitializer 이것도 확장해야한다 라는 내용이다.</p>

<p>내가 궁금했던 케이스랑은 다르긴 한데 위 글의 질문자가 올린 코멘트를 통해서 docs는 <strong>War로 생성한다는 가정하에</strong> AbstractSecurityWebApplicationInitializer를 직접 구현하라고 되어있는 것을 알게 되었다.
자 그럼 다음 글을 읽어보자.</p>

<h4 id="2-4-websecurityconfigureradapter-and-abstractsecuritywebapplicationinitializer-absent">2-4. WebSecurityConfigurerAdapter and AbstractSecurityWebApplicationInitializer absent</h4>
<details>
<summary>[질문 상세 내용]</summary>
<div>

    <p>내가 본 대부분의 예시는<br />
1) Configuration 설정을 위한 WebSecurityConfigurerAdapter<br />
2) 세큐리티 필터 초기화를 위한 AbstractSecurityWebApplicationInitializer</p>

    <p>직장 내 프로젝트에서 스프링 세큐리티를 쓰고있는데 위에서 언급된 클래스 중 어떤 것도 사용할 수 없었다.</p>

    <blockquote>
      <p>그럼 어떻게 내 프로젝트에서 스프링세큐리티를 초기화하고 구성할 수 있을까?</p>
    </blockquote>

    <p>이 프로젝트는 스프링부트를 사용하며 아래 클래스/인터페이스들을 상속/구현하고있다.<br />
a) AuthenticationProvider<br />
b) Authentication<br />
c) Filter</p>

  </div>
</details>

<p><strong>[정리]</strong><br />
jar를 이용한 스프링부트의 자동 구성에 의해 정의가 된다. 전체 workflow는:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">WebSecurityConfigurerAdapter</code> 빈을 등록하지 않았다면, <code class="language-plaintext highlighter-rouge">SpringBootWebSecurityConfiguration</code>이 자동으로 생성해준다.</li>
  <li><code class="language-plaintext highlighter-rouge">WebSecurityEnablerConfiguration</code>은 @EnableWebSecurity가 항상 존재하는지 확인한다.</li>
  <li>@EnableWebSecurity는 스프링 세큐리티 디폴트 구성정보인 WebSecurityConfiguration을 임포트한다. 이 구성정보는 springSecurityFilterChain을 bean을 정의하고 있다.</li>
  <li>SecurityFilterAutoConfiguration은 내장 서버에 springSecurityFilterChain을 등록해준다(FilterRegistrationBean 정의를 통해).<br />
이것은 AbstractSecurityWebApplicationInitializer가 동작하는 방식과 동일하지만 스프링부트 내장형 서버의 방식이다.</li>
</ol>

<p>단, war 이용시 위와 같은 자동 구성이 되지 않으니 <code class="language-plaintext highlighter-rouge">AbstractSecurityWebApplicationInitializer</code>를 직접 구현해야 한다.</p>

<h3 id="3-httpsecurity">3. HTTPSecurity</h3>
<p>WebSecurityConfigurerAdapter에서 configure(HttpSecurity http) 메소드를 제공한다.</p>

<p>이 메소드에서 URL 및 로그인 설정을 함으로써 Spring Security가 어떤 URL에 인증이 필요하고, 어떤 로그인 인증 과정을 사용하는지 알 수 있게 된다.</p>

<p>이 메소드를 통해서 자신만의 인증 메커니즘을 만들 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span> <span class="c1">//Spring Security 설정 활성화</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="c1">//...</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">jwtRequestFilter</span><span class="o">,</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">formLogin</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
            <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span> <span class="c1">//csrf 공격으로부터 안전하고 매번 api 요청으로부터 csrf 토큰을 받지 않아도 되므로 disable 처리함</span>
            <span class="o">.</span><span class="na">cors</span><span class="o">().</span><span class="na">configurationSource</span><span class="o">(</span><span class="n">source</span><span class="o">()).</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">()</span> <span class="c1">//인가에 대한 설정</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/api/oauth/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/api/token/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/h2-console/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/swagger-resources/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// swagger 관련 리소스 시큐리티 필터 제거</span>
            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
    <span class="o">;</span>
  <span class="o">}</span>
  
  <span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>antMatchers를 이용하여 URL을 매치하고, access 및 hasRole 메소드를 이용해 URL에 권한을 부여할 수 있다.</p>

<ul>
  <li>HTTPSecurity 메소드 일부</li>
</ul>

<table>
  <thead>
    <tr>
      <th>메소드</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>annonymous()</td>
      <td>인증 없이 접근 가능한 URL을 정의한다.</td>
    </tr>
    <tr>
      <td>authenticated()</td>
      <td>인증된 사용자만 접근 가능한 URL을 정의한다.</td>
    </tr>
    <tr>
      <td>fullyAuthenticated()</td>
      <td>완전히 인증된 사용자만 접근할 수 있다.</td>
    </tr>
    <tr>
      <td>hasRole() or hasAnyRole()</td>
      <td>인증된 사용자가 주어진 역할을 가지고 있으면 접근 가능한 URL을 정의한다.</td>
    </tr>
    <tr>
      <td>hasAuthority() or hasAnyAuthority()</td>
      <td>특정 권한을 가지는 사용자만 접근할 수 있다.</td>
    </tr>
    <tr>
      <td>hasIpAddress()</td>
      <td>특정 아이피 주소를 가지는 사용자만 접근할 수 있다.</td>
    </tr>
    <tr>
      <td>access()</td>
      <td>SpEL 표현식에 의한 결과에 따라 접근할 수 있다.</td>
    </tr>
    <tr>
      <td>not()</td>
      <td>접근 제한 기능을 해제한다.</td>
    </tr>
    <tr>
      <td>permitAll() or denyAll()</td>
      <td>접근을 전부 허용하거나 제한한다.</td>
    </tr>
  </tbody>
</table>

<p>Role은 역할이고, Authority는 권한이이지만 표현의 차이일 뿐이다.<br />
Role은 “ADMIN”으로 표현하고 Authority는 “ROLE_ADMIN”으로 표현하는 것에 차이가 있다.</p>

<h3 id="4-authenticationmanagerbuilder">4. AuthenticationManagerBuilder</h3>

<p>WebSecurityConfigureAdapter에서 아래 예제의 메소드를 통해서 인증 객체를 설정할 수 있다.</p>
<ul>
  <li>Authentication을 사용한 예</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span> <span class="c1">//Spring Security 설정 활성화</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
  <span class="c1">//...</span>
  <span class="nd">@Autowired</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configureGlobal</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">jwtUserDetailsService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//...</span>
<span class="o">}</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailsService</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">UserDetailsService</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">username</span><span class="o">));</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"404 - User Not Found"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">yapp</span><span class="o">.</span><span class="na">bestFriend</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">UserDetails</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<hr />
<h3 id="참고">참고</h3>
<ul>
  <li><a href="https://dingue.tistory.com/5">Spring Security 개요 및 인증 과정</a></li>
  <li><a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/in-memory.html">In-Memory Authentication</a></li>
  <li><a href="https://stackoverflow.com/questions/22447603/abstractsecuritywebapplicationinitializer-vs-abstractannotationconfigdispatcher">AbstractSecurityWebApplicationInitializer vs. AbstractAnnotationConfigDispatcherServletInitializer</a></li>
  <li><a href="https://stackoverflow.com/questions/56064735/websecurityconfigureradapter-and-abstractsecuritywebapplicationinitializer-absen">WebSecurityConfigurerAdapter and AbstractSecurityWebApplicationInitializer absent</a></li>
  <li><a href="https://godekdls.github.io/Spring%20Security/javaconfiguration/#1613-abstractsecuritywebapplicationinitializer-with-spring-mvc">토리맘의 한글라이즈 프로젝트 - Spring Security Java Configuration</a></li>
</ul>

  
</article>



  <hr class="dingbat related mb6" />






  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    


<img
  
    src="/assets/img/me.jpg"
    
    
  
  alt="Ara cho(IceChoco)"
  class="avatar"
  
  width="120"
  height="120"
  loading="lazy"
/>

  

  
  
  <h2  class="page-title hr-bottom">
    About
  </h2>

  <p>궁금한 걸 참지 않는 개발자</p>


  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/IceChoco" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="mailto:dkfk2685@naver.com" title="Email" class="no-mark-external">
      <span class="icon-mail"></span>
      <span class="sr-only">Email</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://instagram.com/arajjyeoing" title="Instagram" class="no-mark-external">
      <span class="icon-instagram"></span>
      <span class="sr-only">Instagram</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://blog.naver.com/dkfk2685" title="Blogger" class="no-mark-external">
      <span class="icon-blogger"></span>
      <span class="sr-only">Blogger</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
  

  
    


  <aside class="related mb4" role="complementary">  <h2 class="hr-bottom">Related Posts</h2>  <ul class="related-posts">                  <li class="h4">  <a href="/server/2022-05-24-MSA/" class="flip-title"><span>[MSA] Netflix 스택 & K8s 스택</span></a>  <time class="faded fine" datetime="2022-05-24T00:00:00+09:00">24 May 2022</time></li>                        <li class="h4">  <a href="/cs/2022-05-24-Technical-Interview-Expected-Questions-spring/" class="flip-title"><span>[CS] 기술면접 예상 질문 - Spring</span></a>  <time class="faded fine" datetime="2022-05-24T00:00:00+09:00">24 May 2022</time></li>                        <li class="h4">  <a href="/server/2022-05-21-Redis/" class="flip-title"><span>[Server] 전세계에서 가장 유명한 캐싱 솔루션, Redis</span></a>  <time class="faded fine" datetime="2022-05-21T00:00:00+09:00">21 May 2022</time></li>            </ul></aside>

  

  
  

  
    
<aside class="comments related" role="complementary">
  <h2 class="hr-bottom">Comments</h2>
  

  
  
    <script src="https://giscus.app/client.js"
            data-repo=IceChoco/icechoco.github.io
            data-repo-id=R_kgDOGGPhNA
            data-category=Comments
            data-category-id=DIC_kwDOGGPhNM4CAC4O
            data-mapping=pathname
            data-reactions-enabled=1
            data-theme=light
            crossorigin=anonymous
            async>
    </script>
  


</aside>


  


  
<footer class="content" role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2021. All rights reserved.
</small></p>
  
  
    <nav class="legal"><small>
    
      
      <a class="heading flip-title" href="/LICENSE/">LICENSE</a>
      |
    
      
      <a class="heading flip-title" href="/NOTICE/">NOTICE</a>
      |
    
      
      <a class="heading flip-title" href="/CHANGELOG/">CHANGELOG</a>
      
    
    </small></nav>
  
    <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">9.1.4</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

  <hy-drawer
  id="_drawer"
  class=""
  side="left"
  threshold="10"
  noscroll
  
>
  <header id="_sidebar" class="sidebar" role="banner">
    




<div class="sidebar-bg sidebar-overlay" style="background-color:rgb(8,46,57);background-image:url(/assets/img/sidebar-bg2.png)"></div>

    <div class="sidebar-sticky">
  <div class="sidebar-about">
    
      <a class="no-hover" href="/" tabindex="-1">
        <img src="/assets/img/developing-frog.png" class="avatar" alt="IceChoco" width="120" height="120" loading="lazy" />
      </a>
    
    <a class="sidebar-title" href="/"><h2 class="h1">IceChoco</h2></a>
    
    
      <p class="">
        IceChoco의 DevLog

      </p>
    
  </div>

  <div class="sidebar-hits">
    <a class="no-mark-external" href="https://hits.sh/icechoco.github.io/"><img src="https://hits.sh/icechoco.github.io.svg?view=today-total"/></a>
  </div>

  <nav class="sidebar-nav heading" role="navigation">
    <!-- file: "/_layouts/tag-list.html" -->
<ul>
  
  
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a id="_navigation" href="/about/" class="sidebar-nav-item"  >About</a>
            
          </div>
          
        </li>
      
    
  
    
      
    
  
    
      
    
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a  href="/spring/" class="sidebar-nav-item"  >Spring</a>
            
          </div>
          
        </li>
      
    
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a  href="/git/" class="sidebar-nav-item"  >GIT</a>
            
          </div>
          
        </li>
      
    
  
    
      
    
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a  href="/java/" class="sidebar-nav-item"  >Java</a>
            
          </div>
          
        </li>
      
    
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a  href="/database/" class="sidebar-nav-item"  >Database</a>
            
          </div>
          
        </li>
      
    
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a  href="/server/" class="sidebar-nav-item"  >Server</a>
            
          </div>
          
        </li>
      
    
  
    
      
        
        
        <li>
          
          <div class="list-wrapper">
            <a  href="/cs/" class="sidebar-nav-item"  >CS</a>
            
          </div>
          
        </li>
      
    
  
    
      
        
        
        <li>
          
            <input type="checkbox" id="list-item-16" />
          
          <div class="list-wrapper">
            <a  href="/frontend/" class="sidebar-nav-item"  >Front-end</a>
            
              <label class="folder" for="list-item-16">▾</label>
            
          </div>
          
            <ul class="list-body">
                <li>
                  <a class="sidebar-nav-subitem" href="/tag-javascript/">Javascript</a>
                </li>
            
          
            
                <li>
                  <a class="sidebar-nav-subitem" href="/tag-jekyll/">Jekyll</a>
                </li>
            
          
            
                <li>
                  <a class="sidebar-nav-subitem" href="/tag-react/">React</a>
                </li>
            </ul>
          
        </li>
      
    
  
</ul>
  </nav>

  
  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/IceChoco" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="mailto:dkfk2685@naver.com" title="Email" class="no-mark-external">
      <span class="icon-mail"></span>
      <span class="sr-only">Email</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://instagram.com/arajjyeoing" title="Instagram" class="no-mark-external">
      <span class="icon-instagram"></span>
      <span class="sr-only">Instagram</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://blog.naver.com/dkfk2685" title="Blogger" class="no-mark-external">
      <span class="icon-blogger"></span>
      <span class="sr-only">Blogger</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

</hy-push-state>


  <!--[if gt IE 10]><!---->
  <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}();
</script>
  <script src="/assets/js/hydejack-9.1.4.js" type="module"></script>
  <script src="/assets/js/LEGACY-hydejack-9.1.4.js" nomodule defer></script>
  

  

<!--<![endif]-->
  <!-- <script>
  document.querySelector('hy-push-state').setAttribute('prefetch', '');

  document.querySelectorAll('.sidebar a[href^="/"]').forEach(function (el) { 
    el.addEventListener('click', function (e) {
      if (el.pathname === window.location.pathname) {
        e.preventDefault();
        e.stopPropagation();
        document.querySelector('hy-drawer').close();
      }
    });
  });
</script> -->

<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>





<div hidden>
  
  <h2 class="sr-only">Templates (for web app):</h2>

  <clap-config>
    <clap-text at="1">Keep going!</clap-text>
    <clap-text at="2">Keep going ×2!</clap-text>
    <clap-text at="3">Give me more!</clap-text>
    <clap-text at="5">Thank you, thank you</clap-text>
    <clap-text at="7">Far too kind!</clap-text>
    <clap-text at="10">Never gonna give me up?</clap-text>
    <clap-text at="14">Never gonna let me down?</clap-text>
    <clap-text at="20">Turn around and desert me!</clap-text>
    <clap-text at="30">You're an addict!</clap-text>
    <clap-text at="40">Son of a clapper!</clap-text>
    <clap-text at="50">No way</clap-text>
    <clap-text at="60">Go back to work!</clap-text>
    <clap-text at="70">This is getting out of <em>hand</em></clap-text>
    <clap-text at="80">Unbelievable</clap-text>
    <clap-text at="90">PREPOSTEROUS</clap-text>
    <clap-text at="100">I N S A N I T Y</clap-text>
    <clap-text at="185"><span style="font-family:monospace">FEED ME A STRAY CAT</span></clap-text>
  </clap-config>

  <template id="_animation-template">
  <div class="animation-main fixed-top">
    <nav id="breadcrumbs" class="screen-only"><ul>
  
  
</ul></nav>
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

  <template id="_loading-template">
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

  <template id="_error-template">
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

  <template id="_permalink-template">
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="content-hash"></span>
  </a>
</template>

</div>


  
<hr class="sr-only"/>
<h2 class="sr-only">Templates (for web app):</h2>

<template id="_animation-template">
  <div class="animation-main fixed-top">
    <nav id="breadcrumbs" class="screen-only"><ul>
  
  
</ul></nav>
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template">
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template">
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template">
    <a id="_back" class="back nav-btn no-hover">
      <span class="sr-only">Back</span>
      <span class="icon-arrow-left2"></span>
    </a>
  </template>
<template id="_permalink-template">
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="content-hash"></span>
  </a>
</template>


</body>
</html>
